package kz.narxoz.numerology.service;

import kz.narxoz.numerology.dto.NumerologyRequest;
import kz.narxoz.numerology.model.NumerologyResult;
import kz.narxoz.numerology.repository.NumerologyResultRepository;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.web.server.ResponseStatusException;

import java.util.HashMap;
import java.util.Map;

@Service
public class NumerologyService {

    private static final Map<Character, Integer> LETTER_MAP = new HashMap<>();

    static {
        addLetters("AIJQY", 1);
        addLetters("BKR", 2);
        addLetters("CLSG", 3);
        addLetters("DMT", 4);
        addLetters("EHNX", 5);
        addLetters("UVW", 6);
        addLetters("OZ", 7);
        addLetters("FP", 8);
    }

    private final NumerologyResultRepository repository;

    public NumerologyService(NumerologyResultRepository repository) {
        this.repository = repository;
    }

    public NumerologyResult calculate(NumerologyRequest request) {
        validate(request);

        String latinName = transliterateRuToEn(request.name());
        int nameNumber = calculateNameNumber(latinName);
        int consciousnessNumber = calculateConsciousnessNumber(request.day());
        int missionNumber = calculateMissionNumber(request.day(), request.month(), request.year());

        NumerologyResult result = new NumerologyResult(
                null,
                request.name(),
                latinName.toUpperCase(),
                nameNumber,
                getNameMeaning(nameNumber),
                consciousnessNumber,
                getConsciousnessMeaning(consciousnessNumber),
                missionNumber,
                getMissionMeaning(missionNumber)
        );

        return repository.save(result);
    }

    private void validate(NumerologyRequest request) {
        if (request.name() == null || request.name().isBlank()) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Name is required");
        }
        if (request.day() < 1 || request.day() > 31) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Day must be between 1 and 31");
        }
        if (request.month() < 1 || request.month() > 12) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Month must be between 1 and 12");
        }
        if (request.year() < 1) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Year must be positive");
        }
    }

    private static void addLetters(String letters, int value) {
        for (char c : letters.toCharArray()) {
            LETTER_MAP.put(c, value);
        }
    }

    private String transliterateRuToEn(String name) {
        StringBuilder sb = new StringBuilder();
        for (char ch : name.toCharArray()) {
            char c = Character.toLowerCase(ch);
            switch (c) {
                case 'а': sb.append("a"); break;
                case 'б': sb.append("b"); break;
                case 'в': sb.append("v"); break;
                case 'г': sb.append("g"); break;
                case 'д': sb.append("d"); break;
                case 'е': sb.append("e"); break;
                case 'ё': sb.append("e"); break;
                case 'ж': sb.append("zh"); break;
                case 'з': sb.append("z"); break;
                case 'и': sb.append("i"); break;
                case 'й': sb.append("i"); break;
                case 'к': sb.append("k"); break;
                case 'л': sb.append("l"); break;
                case 'м': sb.append("m"); break;
                case 'н': sb.append("n"); break;
                case 'о': sb.append("o"); break;
                case 'п': sb.append("p"); break;
                case 'р': sb.append("r"); break;
                case 'с': sb.append("s"); break;
                case 'т': sb.append("t"); break;
                case 'у': sb.append("u"); break;
                case 'ф': sb.append("f"); break;
                case 'х': sb.append("kh"); break;
                case 'ц': sb.append("ts"); break;
                case 'ч': sb.append("ch"); break;
                case 'ш': sb.append("sh"); break;
                case 'щ': sb.append("shch"); break;
                case 'ы': sb.append("y"); break;
                case 'э': sb.append("e"); break;
                case 'ю': sb.append("iu"); break;
                case 'я': sb.append("ia"); break;
                default:
                    sb.append(ch);
            }
        }
        return sb.toString();
    }

    private int reduceToOneDigit(int num) {
        while (num > 9) {
            int tmp = 0;
            while (num > 0) {
                tmp += num % 10;
                num /= 10;
            }
            num = tmp;
        }
        return num;
    }

    private int calculateNameNumber(String name) {
        name = name.toUpperCase();
        int sum = 0;
        for (char c : name.toCharArray()) {
            Integer val = LETTER_MAP.get(c);
            if (val != null) {
                sum += val;
            }
        }
        return reduceToOneDigit(sum);
    }

    private int calculateConsciousnessNumber(int day) {
        return reduceToOneDigit(day);
    }

    private int calculateMissionNumber(int day, int month, int year) {
        int sum = sumDigits(day) + sumDigits(month) + sumDigits(year);
        return reduceToOneDigit(sum);
    }

    private int sumDigits(int x) {
        int s = 0;
        while (x > 0) {
            s += x % 10;
            x /= 10;
        }
        return s;
    }

    public static String getNameMeaning(int num) {
        switch (num) {
            case 1:
                return "Имя-1 Популярность: даёт энергию лидерства и притяжения. Человек с таким именем часто оказывается в центре внимания, способен брать инициативу и вести за собой. Это имя — про независимость, силу характера и уверенность. В отношениях даёт шанс быть индивидуальностью, выделяться. Хорошо подходит тем, кто стремится быть первыми и отличаться от других.";
            case 2:
                return "Имя-2 Личное благополучие, к замужеству: несёт мягкость, обаяние и способность ладить с людьми. Оно помогает в гармонии, партнёрстве и взаимопонимании. Люди с таким именем часто притягивают дружбу, доверие и душевную близость. Это имя подходит тем, кто ценит гармонию, отношения и взаимность. Оно даёт шанс на стабильность и эмоциональный комфорт.";
            case 3:
                return "Имя-3 Солидность: даёт артистизм, харизму и лёгкость в общении. Такие люди умеют говорить, творить, легко находят общий язык и привлекают внимание. Это имя благоприятно для тех, кто любит творчество, самовыражение и жизнь, полную новых впечатлений. Оно даёт энергию оптимизма и открытости. Но чтобы жизнь была стабильной, важно сохранять баланс.";
            case 4:
                return "Имя-4 Отчуждённость: даёт стабильность, дисциплину и умение строить надёжный фундамент. Человек с таким именем склонен к порядку, планированию и устойчивости. Это имя хорошо подходит для тех, кто ценит безопасность, надёжность, долгосрочные цели. Оно даёт способность доводить дела до конца и быть ответственным. В жизни даёт опору и уверенность.";
            case 5:
                return "Имя-5 Артистизм: приносит свободу, перемены и стремление к новому. Люди-пятёрки любят путешествия, независимость, разнообразие и эксперименты. Это имя хорошо подходит искателям приключений и перемен, тем, кто не боится нестабильности. Оно даёт гибкость и адаптивность. Но важно сохранять внутренний стержень, чтобы не потеряться в потоках изменений.";
            case 6:
                return "Имя-6 Успех, к замужеству: дарит тепло, заботу, гармонию и семейное чувство. Такие люди ценят близкие отношения, уют, поддержку, заботу. Это имя приносит склонность к любви, доброте и заботе о других. Хорошо для тех, кто ищет стабильность, близкие связи и доверие. Оно даёт шанс на тёплую атмосферу, дружбу и надёжность.";
            case 7:
                return "Имя-7 Вызов природе: даёт глубину, интуицию и склонность к самопознанию. Люди-семёрки часто задумываются о смысле жизни, ищут духовность, внутренний мир и гармонию. Это имя подходит тем, кто склонен к философии, анализу, внутренним размышлениям. Оно даёт шанс на мудрость, самостоятельность и внутренний рост. Важно сохранять внутренний баланс и не уходить в изоляцию.";
            case 8:
                return "Имя-8 Постоянный упорный труд: приносит силу, целеустремлённость, трудолюбие и стремление к реализации. Такие люди способны добиваться целей, работать над собой, строить карьеру и достигать материальной стабильности. Это имя хорошо подходит амбициозным, целеустремлённым и решительным людям. Оно даёт шансы на успех, результат и уверенность в своих силах.";
            case 9:
                return "Имя-9 Эмоциональная глубина: даёт эмоциональную глубину, сострадание, гуманность и желание помогать. Люди-девятки часто чувствительны, отзывчивы, способны к великой эмоциональной чуткости. Это имя подходит тем, кто хочет быть полезным, поддерживать других, нести свет и добро. Оно даёт шанс на духовную насыщенность, эмпатию и человечность.";
            default:
                return "Имя — число вне диапазона 1–9.";
        }
    }

    public static String getConsciousnessMeaning(int num) {
        switch (num) {
            case 1:
                return "Сознание-1 Единица: даёт вектор лидерства и индивидуальности. Душа стремится к власти, самоутверждению и самостоятельности. Такие люди часто берут инициативу, принимают решения и идут своим путём. Они чувствуют себя сильными, когда контролируют ситуацию и ведут за собой. Важно быть честным и ответственным, чтобы использовать эту энергию конструктивно.";
            case 2:
                return "Сознание-2 Двойка: даёт способность к дипломатии, чуткости и сотрудничеству. Человек чувствует потребность в гармонии, взаимопонимании и мягкости отношений. Он склонен к эмпатии, поддержке и умении слушать других. В коллективе — хороший союзник, в отношениях — надёжный партнёр. Главное — сохранять баланс и не идти на компромиссы в ущерб себе.";
            case 3:
                return "Сознание-3 Тройка: даёт творческий, коммуникативный вектор. Душа стремится к самовыражению, общению, яркой жизни. Человек общителен, артистичен, любит идеи и новые впечатления. Он может вдохновлять, мотивировать, вести за собой. Но важно не распыляться и направлять энергию цельно, чтобы избежать хаоса.";
            case 4:
                return "Сознание-4 Четверка: даёт практичность, устойчивость и желание строить надёжные структуры. Душа склонна к дисциплине, ответственности и порядку. Такие люди ценят стабильность, планирование и системность. Они хорошо справляются с рутинной работой, умеют брать обязательства и доводить дела до конца. Но важно не загонять себя в рамки и давать место гибкости.";
            case 5:
                return "Сознание-5 Пятерка: даёт жажду свободы, перемен и независимость. Душа ищет новизну, разнообразие и гибкость. Человек открыт приключениям, переменам, может легко адаптироваться. Он не любит однообразия и рутины. Главное — направлять эту энергию разумно, чтобы она работала на рост, а не на хаос.";
            case 6:
                return "Сознание-6 Шестерка: даёт стремление к гармонии, заботе, комфорту и теплым отношениям. Душа ищет уют, любовь и поддержку. Такие люди ценят семейные и дружеские связи, комфорт и стабильность. Они склонны быть заботливыми, надёжными и отзывчивыми. Важно не рассеивать себя, а сохранять баланс между собственными и чужими нуждами.";
            case 7:
                return "Сознание-7 Семерка: даёт глубину, интуицию и склонность к самопознанию. Душа стремится к смыслу, духовному росту и внутренней гармонии. Такие люди могут быть задумчивыми, философичными, искателями истины. Им важно время на анализ, покой, внутренний мир. Главное — не уходить в изоляцию, а использовать энергию для роста и развития.";
            case 8:
                return "Сознание-8 Восьмерка: даёт силу, стремление к результату, дисциплину и устойчивость. Душа направлена на практическую реализацию, достижение целей, материальную устойчивость. Такие люди способны преодолевать трудности, работать усердно, добиваться результата. Важно сохранять баланс, чтобы сила работала на созидание, а не на жёсткость и контроль.";
            case 9:
                return "Сознание-9 Девятка: даёт идеалы, стремление к справедливости, сострадание и желание действовать. Душа тянется к помощи, глубине, пониманию, честности. Такие люди могут быть вдохновителями, защищать слабых, стремиться к высоким целям. Главное — направлять энергию конструктивно, избегая крайностей чувств и максимализма.";
            default:
                return "Число сознания вне диапазона 1–9.";
        }
    }

    public static String getMissionMeaning(int num) {
        switch (num) {
            case 1:
                return "Миссия-1 Власть — означает путь власти, лидерства и ответственности. Человек призван брать на себя инициативу, управлять, вести за собой. Его задача — быть тем, кто принимает решения, создает порядок и направления. Он может стать лидером, организатором, наставником. Главное — честность и осознанность в том, что ведёшь других.";
            case 2:
                return "Миссия-2 Творчество и Психология — путь творчества, психологии и гармонии в отношениях. Человек может реализоваться в помощь, поддержке, коммуникации, искусстве, совете людям. Он призван строить мосты, объединять, создавать гармонию. Его сила — в эмпатии, душевной чуткости и умении понимать. Это путь мягкости, доверия и взаимопонимания.";
            case 3:
                return "Миссия-3 Анализ — путь анализа, знаний, исследования, разума. Человек призван учиться, изучать, анализировать, искать истину. Он может стать учёным, аналитиком, консультантом, философом. Его задача — мыслить, исследовать, давать мудрые советы, делиться знаниями. Это путь дисциплины ума и ответственности за полученную информацию.";
            case 4:
                return "Миссия-4 Передача тайных знаний — путь передачи знаний, наставничества и стабильной службы. Человек может стать учителем, ментором, наставником, строителем надёжных основ. Его задача — помогать другим, передавать опыт, создавать устойчивые системы. Это путь ответственности, порядка, мудрости и поддержки.";
            case 5:
                return "Миссия-5 Борьба — путь перемен, борьбы, риска и свободы. Человек может быть новатором, реформатором, тем, кто ломает старое и строит новое. Его задача — бросать вызов, менять, освобождать, двигаться нестандартно. Это путь авантюр, перемен и смелых решений. Главное — честность, смелость и готовность нести ответственность за свои поступки.";
            case 6:
                return "Миссия-6 Творчество — путь творчества, любви, гармонии, заботы и поддержки. Человек призван создавать уют, красоту, стабильность, доверие. Он может работать в искусстве, семье, отношениях, воспитании, заботе о других. Его задача — нести тепло, комфорт, любовь и поддержку. Это путь баланса, заботы и ответственности за близких.";
            case 7:
                return "Миссия-7 Йога — путь духовного роста, йоги, самопознания, внутреннего поиска. Человек призван развивать сознание, искать смысл, медитировать, изучать себя. Его задача — идти по пути мудрости, духовности, внутреннего света. Это путь саморазвития, самопознания, гармонии с собой и миром.";
            case 8:
                return "Миссия-8 Упорный труд — путь упорного труда, реализации, построения и роста. Человек призван работать, создавать, добиваться, строить карьеру или дело. Это путь дисциплины, силы, ответственности и результата. Он даёт шанс на стабильность, успех и реализацию целей через честный труд.";
            case 9:
                return "Миссия-9 Служение людям — путь служения людям, помощи, гуманизма и поддержки. Человек призван быть полезным, поддерживать, помогать, нести свет и добро. Его задача — служить обществу, быть опорой, приносить сострадание и заботу. Это путь большой ответственности, духовности и самопожертвования ради других.";
            default:
                return "Число миссии вне диапазона 1–9.";
        }
    }
}
